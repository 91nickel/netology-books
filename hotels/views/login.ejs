<%- include("./header") %>
<div class="row">
    <div class="col-12 col-md-6">
        <h2><%= firstTitle %></h2>
        <form method="POST" id="login" class="mt-5">
            <div class="form-group">
                <label for="inputLogin">login</label>
                <input type="text"
                       name="login"
                       class="form-control"
                       required
                       id="inputLogin"/>
            </div>
            <div class="form-group">
                <label for="inputPassword">password</label>
                <input type="password"
                       name="password"
                       class="form-control"
                       required
                       id="inputPassword"/>
            </div>
            <div class="form-group text-right ">
                <button type="submit" class="btn btn-primary">Log in</button>
            </div>
        </form>
    </div>
    <div class="col-12 col-md-6">
        <h2 class="mb-5"><%= secondTitle %></h2>
        <form method="POST" action="/user/signup">
            <div class="form-group">
                <label for="inputName">Name</label>
                <input type="text"
                       name="name"
                       class="form-control"
                       required
                       id="inputName">
            </div>
            <div class="form-group">
                <label for="inputEmail">email</label>
                <input type="email"
                       name="email"
                       class="form-control"
                       required
                       id="inputEmail">
            </div>
            <div class="form-group">
                <label for="inputPassword">password</label>
                <input type="password"
                       name="password"
                       class="form-control"
                       required
                       id="inputPassword">
            </div>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <div class="form-group text-right ">
                <button type="submit" class="btn btn-primary">Sign Up</button>
            </div>
        </form>

    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-auth.js"></script>

<script>
    const get_cookie = (cookie_name) => {
        const results = document.cookie.match('(^|;) ?' + cookie_name + '=([^;]*)(;|$)');
        return results ? results[2] : null;
    };

    window.addEventListener("DOMContentLoaded", () => {
        const firebaseConfig = {
            apiKey: "AIzaSyDxksG2IkEQNc7a_QlIVJpXvRUQ4KTiTHo",
            authDomain: "netology-node.firebaseapp.com",
            databaseURL: "https://netology-node-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "netology-node",
            storageBucket: "netology-node.appspot.com",
            messagingSenderId: "925483389659",
            appId: "1:925483389659:web:dbc1a307c312570cd372fe",
            measurementId: "G-DMXY2TRBP9"
        };
        firebase.initializeApp(firebaseConfig);
        firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE);

        document
            .getElementById("login")
            .addEventListener("submit", (event) => {
                event.preventDefault();
                const login = event.target.login.value;
                const password = event.target.password.value;

                firebase
                    .auth()
                    .signInWithEmailAndPassword(login, password)
                    .then(({user}) => {
                        return user.getIdToken().then(idToken => {
                            return fetch("/user/login", {
                                method: "POST",
                                headers: {
                                    "Accept": "application/json",
                                    "Content-Type": "application/json",
                                    "CSRF-Token": get_cookie("XSRF-TOKEN"),
                                },
                                body: JSON.stringify({idToken}),
                            });
                        });
                    })
                    .then(() => {
                        // return firebase.auth().signOut();
                    })
                    .then(() => {
                        return window.location = '/user/profile'
                    });
                return false;
            });
    });
</script>
<%- include("./footer") %>